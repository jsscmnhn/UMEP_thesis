<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>src.j_dataprep.DEMs - SOLFD 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">SOLFD 1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  
  <span class="sidebar-brand-text">SOLFD 1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../runningthecode.html">Running the Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howworks.html">How SOLFD works</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../src.html">src package</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of src package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../src.functions.html">src.functions</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of src.functions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../src.functions.SOLWEIGpython.html">functions.SOLWEIGpython</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of functions.SOLWEIGpython</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../src.functions.SOLWEIGpython.UTIL.html">src.functions.SOLWEIGpython.UTIL</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../src.j_analysis.html">src.j_analysis package</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../src.j_dataprep.html">src.j_dataprep package</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of src.j_dataprep package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../src.j_dataprep.climate.html">src.j_dataprep.climate package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../src.j_dataprep.geotiles.html">src.j_dataprep.geotiles package</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../src.j_output.html">src.j_output package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../src.preprocessor.html">src.preprocessor package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../src.processor.html">src.processor package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../src.util.html">src.util package</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for src.j_dataprep.DEMs</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">geometry_mask</span><span class="p">,</span> <span class="n">shapes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">NearestNDInterpolator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">startinpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio</span><span class="w"> </span><span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">shape</span><span class="p">,</span><span class="n">box</span><span class="p">,</span> <span class="n">mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.crs</span><span class="w"> </span><span class="kn">import</span> <span class="n">CRS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">laspy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">cKDTree</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">median_filter</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">maximum_filter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rtree</span><span class="w"> </span><span class="kn">import</span> <span class="n">index</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ezdxf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.affinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">translate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.enums</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resampling</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.warp</span><span class="w"> </span><span class="kn">import</span> <span class="n">reproject</span>
<span class="c1"># from landcover import LandCover</span>

<div class="viewcode-block" id="edit_bounds">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.edit_bounds">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_bounds</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Expands or shrinks bounding box coordinates by a buffer amount.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        bounds (tuple): Bounding box as (min_x, min_y, max_x, max_y).</span>
<span class="sd">        buffer (float): Amount to expand or shrink the bounding box.</span>
<span class="sd">        shrink (bool):  If True, shrink the bounds by buffer; else expand (default False).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Modified bounding box as (min_x, min_y, max_x, max_y).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">bounds</span>

    <span class="k">if</span> <span class="n">shrink</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">min_x</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="n">min_y</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="n">max_x</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="n">max_y</span> <span class="o">-</span> <span class="n">buffer</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">min_x</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="n">min_y</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="n">max_x</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="n">max_y</span> <span class="o">+</span> <span class="n">buffer</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="write_output">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.write_output">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_output</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">change_nodata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Writes a numpy array to a GeoTIFF file using rasterio.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        dataset        :        Rasterio or laspy dataset (for metadata).</span>
<span class="sd">        crs            :        Coordinate Reference System for the output raster.</span>
<span class="sd">        output (np.ndarray):    Output numpy array grid to write.</span>
<span class="sd">        transform      :        Affine transform mapping pixel to spatial coordinates.</span>
<span class="sd">        name (str)     :        Output filename (including path).</span>
<span class="sd">        change_nodata (bool):   If True, use nodata value -9999; else use dataset&#39;s nodata.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">name</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="c1"># Set the nodata value: use -9999 if nodata_value is True or dataset does not have nodata.</span>
    <span class="k">if</span> <span class="n">change_nodata</span><span class="p">:</span>
        <span class="n">nodata_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TO DO: CHANGE THIS TO JUST INPUTTING A NODATA VALUE, NO NEED FOR THE WHOLE DATASET IN THIS FUNCTION</span>
            <span class="n">nodata_value</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">nodata</span>
            <span class="k">if</span> <span class="n">nodata_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No no data value found in dataset.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Defaulting to -9999.&quot;</span><span class="p">)</span>
            <span class="n">nodata_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>

    <span class="c1"># output the dataset</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                       <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span>
                       <span class="n">height</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># Assuming output is (rows, cols)</span>
                       <span class="n">width</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                       <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
                       <span class="n">nodata</span><span class="o">=</span><span class="n">nodata_value</span><span class="p">,</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File written to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">output_file</span><span class="p">)</span></div>



<div class="viewcode-block" id="Buildings">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.Buildings">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Buildings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Manage 3D building data within a bounding box by downloading, loading,</span>
<span class="sd">    and modifying building geometries from a WFS service.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        bbox (tuple):                   Bounding box (min_x, min_y, max_x, max_y) for the area of interest.</span>
<span class="sd">        bufferbbox (tuple):             Buffered bounding box expanded by 2 units.</span>
<span class="sd">        wfs_url (str):                  URL of the WFS service to download building data.</span>
<span class="sd">        layer_name (str):               WFS layer name to query.</span>
<span class="sd">        data (GeoDataFrame):            Downloaded building data.</span>
<span class="sd">        building_geometries (list):     List of building geometries with parcel IDs.</span>
<span class="sd">        removed_buildings (list):       List of parcel IDs of removed buildings.</span>
<span class="sd">        user_buildings (list):          List of user-inserted building geometries.</span>
<span class="sd">        user_buildings_higher (list):   List of user buildings with height info.</span>
<span class="sd">        removed_user_buildings (list):  List of user building IDs that are removed.</span>
<span class="sd">        is3D (bool):                    Flag indicating if 3D building data is used.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">wfs_url</span><span class="o">=</span><span class="s2">&quot;https://data.3dbag.nl/api/BAG3D/wfs&quot;</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s2">&quot;BAG3D:lod13&quot;</span><span class="p">,</span> <span class="n">gpkg_name</span><span class="o">=</span><span class="s2">&quot;buildings&quot;</span><span class="p">,</span> <span class="n">output_folder</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">output_layer_name</span><span class="o">=</span><span class="s2">&quot;buildings&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize the Buildings object by setting bounding boxes, downloading,</span>
<span class="sd">        and loading building data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            bbox (tuple):               Bounding box (min_x, min_y, max_x, max_y).</span>
<span class="sd">            wfs_url (str):              URL for the WFS service. Default is 3dbag.nl API.</span>
<span class="sd">            layer_name (str):           Name of the WFS layer to query. Default is &quot;BAG3D:lod13&quot;.</span>
<span class="sd">            gpkg_name (str):            Name of the GeoPackage output file (without extension).</span>
<span class="sd">            output_folder (str):        Folder to save the downloaded data.</span>
<span class="sd">            output_layer_name (str):    Layer name to save within the GeoPackage.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bufferbbox</span> <span class="o">=</span> <span class="n">edit_bounds</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfs_url</span> <span class="o">=</span> <span class="n">wfs_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_wfs_data</span><span class="p">(</span><span class="n">gpkg_name</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">output_layer_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">building_geometries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_buildings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_buildings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_buildings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_buildings_higher</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_user_buildings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Buildings.download_wfs_data">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.Buildings.download_wfs_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_wfs_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpkg_name</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Download building features from the WFS service within the buffered bounding box.</span>
<span class="sd">        Saves the data as a GeoPackage file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            gpkg_name (str):        Filename for the GeoPackage (without extension).</span>
<span class="sd">            output_folder (str):    Folder to save the GeoPackage.</span>
<span class="sd">            layer_name (str):       Layer name to use inside the GeoPackage.</span>

<span class="sd">        Returns:</span>
<span class="sd">            GeoDataFrame:           Downloaded building features concatenated, or None if no features were downloaded.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">10000</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;SERVICE&quot;</span><span class="p">:</span> <span class="s2">&quot;WFS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;REQUEST&quot;</span><span class="p">:</span> <span class="s2">&quot;GetFeature&quot;</span><span class="p">,</span>
                <span class="s2">&quot;VERSION&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0.0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;TYPENAMES&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_name</span><span class="p">,</span>
                <span class="s2">&quot;SRSNAME&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:ogc:def:crs:EPSG::28992&quot;</span><span class="p">,</span>
                <span class="s2">&quot;BBOX&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">,urn:ogc:def:crs:EPSG::28992&quot;</span><span class="p">,</span>
                <span class="s2">&quot;COUNT&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
                <span class="s2">&quot;STARTINDEX&quot;</span><span class="p">:</span> <span class="n">start_index</span>
            <span class="p">}</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 QGIS/33411/Windows 11 Version 2009&quot;</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gzip&#39;</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">[</span>
                                                                                      <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x1f\x8b</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>

                <span class="k">with</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">start_index</span> <span class="o">+=</span> <span class="n">count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download WFS data. Status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error message: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">all_features</span><span class="p">:</span>
            <span class="n">full_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">output_gpkg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gpkg_name</span><span class="si">}</span><span class="s2">.gpkg&quot;</span><span class="p">)</span>
            <span class="n">full_gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_gpkg</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer_name</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loaded&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">full_gdf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No features were downloaded.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Buildings.load_buildings">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.Buildings.load_buildings">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_buildings</span><span class="p">(</span><span class="n">buildings_gdf</span><span class="p">,</span> <span class="n">buildings_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load building geometries from a GeoDataFrame or from a file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            buildings_gdf (GeoDataFrame or None):   Building data GeoDataFrame.</span>
<span class="sd">            buildings_path (str or None):           Path to building file to load if GeoDataFrame is None.</span>
<span class="sd">            layer (str or None):                    Layer name to read from file if applicable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list:   List of dicts with &#39;geometry&#39; (GeoJSON mapping) and &#39;parcel_id&#39;. None if no data could be loaded.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">buildings_gdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">buildings_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">buildings_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">buildings_path</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span> <span class="s2">&quot;parcel_id&quot;</span><span class="p">:</span> <span class="n">identificatie</span><span class="p">}</span> <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">identificatie</span> <span class="ow">in</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">buildings_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">buildings_gdf</span><span class="p">[</span><span class="s2">&quot;identificatie&quot;</span><span class="p">])]</span></div>


<div class="viewcode-block" id="Buildings.remove_buildings">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.Buildings.remove_buildings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_buildings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identification</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Mark a building as removed by adding its parcel ID to the removed list.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            identification (str):   Parcel ID of the building to remove.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_buildings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identification</span><span class="p">)</span></div>


<div class="viewcode-block" id="Buildings.retrieve_buildings">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.Buildings.retrieve_buildings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">retrieve_buildings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identification</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Undo the removal of a building by removing its parcel ID from the removed list.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            identification (str):   Parcel ID of the building to retrieve.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">removed_buildings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">identification</span><span class="p">)</span></div>


<div class="viewcode-block" id="Buildings.insert_user_buildings">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.Buildings.insert_user_buildings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert_user_buildings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">highest_array</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">footprint_array</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Insert user-defined buildings based on arrays of building heights and optional footprints.</span>
<span class="sd">        Assigns unique parcel IDs and matches footprint buildings with highest buildings.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            highest_array (np.ndarray):             Array representing the highest building heights.</span>
<span class="sd">            transform (Affine):                     Rasterio affine transform for spatial referencing.</span>
<span class="sd">            footprint_array (np.ndarray or None):   Optional array representing building footprints.</span>

<span class="sd">        Effects:</span>
<span class="sd">            Updates self.user_buildings, self.user_buildings_higher, and self.is3D.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span> <span class="o">=</span> <span class="n">footprint_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_user_buildings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_buildings_higher</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_clusters</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">highest_array</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">shapes_highest</span> <span class="o">=</span> <span class="n">shapes</span><span class="p">(</span><span class="n">labeled_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">labeled_array</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>

        <span class="n">highest_buildings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">geom</span><span class="p">)),</span> <span class="s2">&quot;parcel_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">shapes_highest</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">footprint_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rtree_index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">Index</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">building</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">highest_buildings</span><span class="p">):</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
                <span class="n">rtree_index</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

            <span class="n">labeled_footprint_array</span><span class="p">,</span> <span class="n">num_clusters_fp</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">footprint_array</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">shapes_fp</span> <span class="o">=</span> <span class="n">shapes</span><span class="p">(</span><span class="n">labeled_footprint_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">labeled_footprint_array</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                                   <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>

            <span class="n">footprint_buildings</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">geom</span><span class="p">)),</span> <span class="s2">&quot;parcel_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]}</span>
                <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">shapes_fp</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">footprint_building</span> <span class="ow">in</span> <span class="n">footprint_buildings</span><span class="p">:</span>
                <span class="n">footprint_geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">footprint_building</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>

                <span class="n">possible_matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">rtree_index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">footprint_geom</span><span class="o">.</span><span class="n">bounds</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">match_idx</span> <span class="ow">in</span> <span class="n">possible_matches</span><span class="p">:</span>
                    <span class="n">highest_building</span> <span class="o">=</span> <span class="n">highest_buildings</span><span class="p">[</span><span class="n">match_idx</span><span class="p">]</span>
                    <span class="n">highest_geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">highest_building</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">footprint_geom</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">highest_geom</span><span class="p">)</span> <span class="ow">or</span> <span class="n">footprint_geom</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">highest_geom</span><span class="p">):</span>
                        <span class="n">footprint_building</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">highest_building</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_buildings</span> <span class="o">=</span> <span class="n">footprint_buildings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_buildings_higher</span> <span class="o">=</span> <span class="n">highest_buildings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_buildings</span> <span class="o">=</span> <span class="n">highest_buildings</span></div>


<div class="viewcode-block" id="Buildings.remove_user_buildings">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.Buildings.remove_user_buildings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_user_buildings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identification</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Mark a user building as removed by adding its parcel ID to the removed list.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            identification (str): Parcel ID of the user building to remove.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_user_buildings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identification</span><span class="p">)</span></div>


<div class="viewcode-block" id="Buildings.retrieve_user_buildings">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.Buildings.retrieve_user_buildings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">retrieve_user_buildings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identification</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Undo the removal of a user building by removing its parcel ID from the removed list.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            identification (str): Parcel ID of the user building to retrieve.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_user_buildings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">identification</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DEMS">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DEMS</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class for handling Digital Elevation Models (DEM) including DTM and DSM,</span>
<span class="sd">    fetching AHN data via WCS, filling missing data, resampling, cropping,</span>
<span class="sd">    and integrating building footprints for urban terrain modeling.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    - buffer (float):                           Buffer size in meters for bbox expansion.</span>
<span class="sd">    - bbox (tuple):                             Bounding box coordinates (xmin, ymin, xmax, ymax).</span>
<span class="sd">    - bufferbbox (tuple):                       Buffered bounding box expanded by buffer.</span>
<span class="sd">    - building_data (list):                     List of building geometries and attributes.</span>
<span class="sd">    - resolution (float):                       Desired output raster resolution in meters.</span>
<span class="sd">    - user_building_data (list):                User-provided building data.</span>
<span class="sd">    - output_dir (str):                         Directory to save output files.</span>
<span class="sd">    - bridge (bool):                            Whether to include &#39;overbruggingsdeel&#39; data in the DSM.</span>
<span class="sd">    - resampling (rasterio.enums.Resampling):   Resampling method for raster operations.</span>
<span class="sd">    - crs (CRS):                                Coordinate reference system, default EPSG:28992.</span>
<span class="sd">    - dtm (np.ndarray):                     Digital Terrain Model raster data.</span>
<span class="sd">    - dsm (np.ndarray):                     Digital Surface Model raster data.</span>
<span class="sd">    - transform (Affine):                       Affine transform for the rasters.</span>
<span class="sd">    - og_dtm (np.ndarray):                  Original DTM before modifications.</span>
<span class="sd">    - og_dsm (np.ndarray):                  Original DSM before modifications.</span>
<span class="sd">    - is3D (bool):                              Flag indicating if DSM is 3D.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">building_data</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">bridge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">cubic_spline</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize the DEM builder object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            bbox (tuple):                           Bounding box coordinates (xmin, ymin, xmax, ymax).</span>
<span class="sd">            building_data (list):                   Building geometries and data.</span>
<span class="sd">            resolution (float):                     Desired output resolution in meters (default 0.5).</span>
<span class="sd">            bridge (bool):                          Whether to include  &#39;overbruggingsdeel&#39; geometries (default False).</span>
<span class="sd">            resampling (rasterio.enums.Resampling): Resampling method (default cubic_spline).</span>
<span class="sd">            output_dir (str):                       Directory for output files (default &quot;output&quot;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bufferbbox</span> <span class="o">=</span> <span class="n">edit_bounds</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">building_data</span> <span class="o">=</span> <span class="n">building_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_building_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bridge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resampling</span> <span class="o">=</span> <span class="n">resampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="p">(</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="mi">28992</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_dem</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">og_dtm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">og_dsm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="DEMS.fetch_ahn_wcs">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.fetch_ahn_wcs">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_ahn_wcs</span><span class="p">(</span><span class="n">bufferbbox</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">coverage</span><span class="o">=</span><span class="s2">&quot;dtm_05m&quot;</span><span class="p">,</span> <span class="n">wcs_resolution</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fetch AHN WCS data for a given buffered bounding box and save as GeoTIFF.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            bufferbbox (tuple):     Buffered bounding box (xmin, ymin, xmax, ymax).</span>
<span class="sd">            output_file (str):      Output filepath for the GeoTIFF (default &quot;output/dtm.tif&quot;).</span>
<span class="sd">            coverage (str):         Coverage layer name, e.g. &quot;dtm_05m&quot; or &quot;dsm_05m&quot; (default &quot;dtm_05m&quot;).</span>
<span class="sd">            wcs_resolution (float): Resolution of WCS data in meters (default 0.5).</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple or None: (rasterio dataset object, numpy array of raster data) if successful, else None.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Calculate width and height from bbox and resolution</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bufferbbox</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">wcs_resolution</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bufferbbox</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">wcs_resolution</span><span class="p">)</span>

        <span class="c1"># WCS Service URL</span>
        <span class="n">WCS_URL</span> <span class="o">=</span> <span class="s2">&quot;https://service.pdok.nl/rws/ahn/wcs/v1_0&quot;</span>

        <span class="c1"># Construct query parameters</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;SERVICE&quot;</span><span class="p">:</span> <span class="s2">&quot;WCS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VERSION&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;REQUEST&quot;</span><span class="p">:</span> <span class="s2">&quot;GetCoverage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;FORMAT&quot;</span><span class="p">:</span> <span class="s2">&quot;GEOTIFF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COVERAGE&quot;</span><span class="p">:</span> <span class="n">coverage</span><span class="p">,</span>
            <span class="s2">&quot;BBOX&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">bufferbbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CRS&quot;</span><span class="p">:</span> <span class="s2">&quot;EPSG:28992&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RESPONSE_CRS&quot;</span><span class="p">:</span> <span class="s2">&quot;EPSG:28992&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WIDTH&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">),</span>
            <span class="s2">&quot;HEIGHT&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Send GET request to fetch the data</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WCS_URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;temp.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;temp.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># TO DO: test if this is still needed after fixing the libraries</span>
                <span class="n">gdal_translate_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gdal_translate -of GTiff -a_srs EPSG:28992 temp.tif </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">gdal_translate_command</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">old_nodata</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">nodata</span>
                    <span class="n">new_nodata</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
                    <span class="n">array</span><span class="p">[</span><span class="n">array</span> <span class="o">==</span> <span class="n">old_nodata</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_nodata</span>

                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">nodata</span> <span class="o">=</span> <span class="n">new_nodata</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading or modifying raster: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Delete the temporary file after use</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;temp.tif&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;temp.tif&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">dst</span><span class="p">,</span> <span class="n">array</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch AHN data: HTTP </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DEMS.extract_center_cells">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.extract_center_cells">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_center_cells</span><span class="p">(</span><span class="n">geo_array</span><span class="p">,</span> <span class="n">no_data</span><span class="o">=-</span><span class="mi">9999</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extract the values of each cell in the input data and save these with the x and y (row and col)</span>
<span class="sd">        indices. Thereby, make sure that the corners of the dataset are filled for a full coverage triangulation</span>
<span class="sd">        in the next step.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            geo_array (np.ndarray):         Raster data array.</span>
<span class="sd">            no_data (int):                  No data value to identify invalid cells (default -9999).</span>

<span class="sd">        Returns:</span>
<span class="sd">            list:                           List of [x, y, z] cell values with corners interpolated if no data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Get the indices of the rows and columns</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">geo_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Identify corner coordinates</span>
        <span class="n">corners</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;top_left&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;top_right&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">geo_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;bottom_left&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">geo_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;bottom_right&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">geo_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">geo_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Mask for valid center cells (non-no_data)</span>
        <span class="n">valid_center_cells</span> <span class="o">=</span> <span class="p">(</span><span class="n">geo_array</span> <span class="o">!=</span> <span class="n">no_data</span><span class="p">)</span>

        <span class="c1"># Extract x, y, z values for valid cells</span>
        <span class="n">x_valid</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">valid_center_cells</span><span class="p">]</span>
        <span class="n">y_valid</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">valid_center_cells</span><span class="p">]</span>
        <span class="n">z_valid</span> <span class="o">=</span> <span class="n">geo_array</span><span class="p">[</span><span class="n">valid_center_cells</span><span class="p">]</span>

        <span class="c1"># Create interpolator from valid points</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">NearestNDInterpolator</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)),</span> <span class="n">z_valid</span><span class="p">)</span>

        <span class="c1"># Check each corner for no data and interpolate if necessary</span>
        <span class="k">for</span> <span class="n">corner_name</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="n">corners</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">geo_array</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">no_data</span><span class="p">:</span>
                <span class="c1"># Interpolate the nearest valid value</span>
                <span class="n">geo_array</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>

        <span class="c1"># Extract non-no_data and center cells again after filling corners</span>
        <span class="n">valid_center_cells</span> <span class="o">=</span> <span class="p">(</span><span class="n">geo_array</span> <span class="o">!=</span> <span class="n">no_data</span><span class="p">)</span>

        <span class="c1"># Extract final x, y, z values after filling corners</span>
        <span class="n">x_filled</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">valid_center_cells</span><span class="p">]</span>
        <span class="n">y_filled</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">valid_center_cells</span><span class="p">]</span>
        <span class="n">z_filled</span> <span class="o">=</span> <span class="n">geo_array</span><span class="p">[</span><span class="n">valid_center_cells</span><span class="p">]</span>

        <span class="c1"># Prepare final list of [x, y, z]</span>
        <span class="n">xyz_filled</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span><span class="p">,</span> <span class="n">z_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_filled</span><span class="p">,</span> <span class="n">y_filled</span><span class="p">,</span> <span class="n">z_filled</span><span class="p">):</span>
            <span class="n">xyz_filled</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span><span class="p">,</span> <span class="n">z_i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">xyz_filled</span></div>


<div class="viewcode-block" id="DEMS.crop_to_bbox">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.crop_to_bbox">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">crop_to_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Crop a buffered raster array to the original bounding box.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            array (np.ndarray): Raster data array with buffer.</span>
<span class="sd">            transform (Affine): Affine transform matrix of input array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            cropped_array (np.ndarray):     Cropped raster array.</span>
<span class="sd">            new_transform (Affine):         New Affine transform matrix for cropped raster.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Compute the window from the full buffered transform, for the smaller (target) bbox</span>
        <span class="n">crop_pixels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>

        <span class="c1"># Crop array: remove buffer from all sides</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">crop_pixels</span><span class="p">)</span>
        <span class="n">cropped_array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">crop_pixels</span><span class="p">:</span><span class="o">-</span><span class="n">crop_pixels</span><span class="p">,</span> <span class="n">crop_pixels</span><span class="p">:</span><span class="o">-</span><span class="n">crop_pixels</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cropped_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Adjust transform: move origin by number of removed pixels</span>
        <span class="n">new_transform</span> <span class="o">=</span> <span class="n">transform</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">crop_pixels</span><span class="p">,</span> <span class="n">crop_pixels</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cropped_array</span><span class="p">,</span> <span class="n">new_transform</span></div>


<div class="viewcode-block" id="DEMS.resample_raster">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.resample_raster">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resample_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_array</span><span class="p">,</span> <span class="n">input_transform</span><span class="p">,</span> <span class="n">input_crs</span><span class="p">,</span> <span class="n">output_resolution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resample a raster to a different resolution.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            input_array (np.ndarray): Input raster data.</span>
<span class="sd">            input_transform (Affine): Affine transform of input raster.</span>
<span class="sd">            input_crs (CRS): Coordinate Reference System of input raster.</span>
<span class="sd">            output_resolution (float): Desired output resolution in meters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            resampled_array (np.ndarray):     Resampled raster array.</span>
<span class="sd">            new_transform (Affine):           New Affine transform matrix for resampled raster.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">input_array</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">new_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">width</span> <span class="o">*</span> <span class="n">input_transform</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">output_resolution</span><span class="p">)</span>
        <span class="n">new_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">height</span> <span class="o">*</span> <span class="o">-</span><span class="n">input_transform</span><span class="o">.</span><span class="n">e</span><span class="p">)</span> <span class="o">/</span> <span class="n">output_resolution</span><span class="p">)</span>

        <span class="n">new_transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">from_origin</span><span class="p">(</span>
            <span class="n">input_transform</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">input_transform</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">output_resolution</span><span class="p">,</span> <span class="n">output_resolution</span>
        <span class="p">)</span>

        <span class="n">resampled_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">new_height</span><span class="p">,</span> <span class="n">new_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">input_array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">reproject</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">input_array</span><span class="p">,</span>
            <span class="n">destination</span><span class="o">=</span><span class="n">resampled_array</span><span class="p">,</span>
            <span class="n">src_transform</span><span class="o">=</span><span class="n">input_transform</span><span class="p">,</span>
            <span class="n">src_crs</span><span class="o">=</span><span class="n">input_crs</span><span class="p">,</span>
            <span class="n">dst_transform</span><span class="o">=</span><span class="n">new_transform</span><span class="p">,</span>
            <span class="n">dst_crs</span><span class="o">=</span><span class="n">input_crs</span><span class="p">,</span>
            <span class="n">resampling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resampling</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">resampled_array</span><span class="p">,</span> <span class="n">new_transform</span></div>


<div class="viewcode-block" id="DEMS.fill_raster">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.fill_raster">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fill_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geo_array</span><span class="p">,</span> <span class="n">nodata_value</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fill no-data values in a raster using Laplace interpolation.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            geo_array (np.ndarray):     Cropped raster data array.</span>
<span class="sd">            nodata_value (int):         No-data value to replace NaNs after interpolation.</span>
<span class="sd">            transform (Affine):         Affine transform matrix of the raster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            new_data(np.ndarray):       Filled raster array with no-data values replaced.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># creating delaunay</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_center_cells</span><span class="p">(</span><span class="n">geo_array</span><span class="p">,</span> <span class="n">no_data</span><span class="o">=</span><span class="n">nodata_value</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">startinpy</span><span class="o">.</span><span class="n">DT</span><span class="p">()</span>
        <span class="n">dt</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="s2">&quot;BBox&quot;</span><span class="p">)</span>

        <span class="c1"># for interpolation, grid of all column and row positions, excluding the first and last rows/cols</span>
        <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">geo_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">geo_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># flatten the grid to get a list of all (col, row) locations</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">cols</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">rows</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
        <span class="n">interpolated_values</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">interpolate</span><span class="p">({</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;Laplace&quot;</span><span class="p">},</span> <span class="n">locs</span><span class="p">)</span>

        <span class="c1"># reshape interpolated grid back to original</span>
        <span class="n">interpolated_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">interpolated_values</span><span class="p">,</span> <span class="p">(</span><span class="n">geo_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geo_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># fill new_data with interpolated values</span>
        <span class="n">new_data</span><span class="o">=</span> <span class="n">interpolated_grid</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">new_data</span><span class="p">),</span> <span class="n">nodata_value</span><span class="p">,</span> <span class="n">new_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_data</span></div>


<div class="viewcode-block" id="DEMS.replace_buildings">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.replace_buildings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_buildings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filled_dtm</span><span class="p">,</span> <span class="n">dsm_buildings</span><span class="p">,</span> <span class="n">buildings_geometries</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">bridge</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Replace filled DTM values with DSM building heights where buildings exist.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            filled_dtm (np.ndarray):        Filled, cropped DTM array.</span>
<span class="sd">            dsm_buildings (np.ndarray):     Filled, cropped DSM array with buildings.</span>
<span class="sd">            buildings_geometries (list):    List of building geometries (dict or GeoJSON features).</span>
<span class="sd">            transform (Affine):             Affine transform matrix of the rasters.</span>
<span class="sd">            bridge (bool):                  Whether to include &#39;overbrugginsdeel&#39; geometries.</span>

<span class="sd">        Returns:</span>
<span class="sd">            final_dsm (np.ndarray):         Final DSM array combining ground and building heights.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">geometries</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">buildings_geometries</span> <span class="k">if</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">building</span><span class="p">]</span>
        <span class="n">bridging_geometries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">bridge</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">bridge_crs</span> <span class="o">=</span> <span class="s2">&quot;http://www.opengis.net/def/crs/EPSG/0/28992&quot;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.pdok.nl/lv/bgt/ogc/v1/collections/overbruggingsdeel/items?bbox=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&amp;bbox-crs=</span><span class="si">{</span><span class="n">bridge_crs</span><span class="si">}</span><span class="s2">&amp;crs=</span><span class="si">{</span><span class="n">bridge_crs</span><span class="si">}</span><span class="s2">&amp;limit=1000&amp;f=json&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">bridging_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;features&quot;</span> <span class="ow">in</span> <span class="n">bridging_data</span><span class="p">:</span>  <span class="c1"># Ensure data contains geometries</span>
                    <span class="n">bridging_geometries</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">bridging_data</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span> <span class="k">if</span>
                                           <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching bridges: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure mask has same shape as filled_dtm</span>
        <span class="n">all_geometries</span> <span class="o">=</span> <span class="n">bridging_geometries</span> <span class="o">+</span> <span class="n">geometries</span>
        <span class="n">building_mask</span> <span class="o">=</span> <span class="n">geometry_mask</span><span class="p">(</span><span class="n">all_geometries</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="n">filled_dtm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Get shape differences</span>
        <span class="n">dtm_shape</span> <span class="o">=</span> <span class="n">filled_dtm</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">dsm_shape</span> <span class="o">=</span> <span class="n">dsm_buildings</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="n">dtm_shape</span> <span class="o">!=</span> <span class="n">dsm_shape</span><span class="p">:</span>
            <span class="c1"># Compute the cropping offsets</span>
            <span class="n">row_diff</span> <span class="o">=</span> <span class="n">dsm_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dtm_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">col_diff</span> <span class="o">=</span> <span class="n">dsm_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dtm_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Ensure even cropping from all sides (center alignment)</span>
            <span class="n">row_start</span> <span class="o">=</span> <span class="n">row_diff</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">col_start</span> <span class="o">=</span> <span class="n">col_diff</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">row_end</span> <span class="o">=</span> <span class="n">row_start</span> <span class="o">+</span> <span class="n">dtm_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">col_end</span> <span class="o">=</span> <span class="n">col_start</span> <span class="o">+</span> <span class="n">dtm_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Crop dsm_buildings to match filled_dtm</span>
            <span class="n">dsm_buildings</span> <span class="o">=</span> <span class="n">dsm_buildings</span><span class="p">[</span><span class="n">row_start</span><span class="p">:</span><span class="n">row_end</span><span class="p">,</span> <span class="n">col_start</span><span class="p">:</span><span class="n">col_end</span><span class="p">]</span>

        <span class="c1"># Apply the mask</span>
        <span class="n">final_dsm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">building_mask</span><span class="p">,</span> <span class="n">filled_dtm</span><span class="p">,</span> <span class="n">dsm_buildings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_dsm</span></div>


<div class="viewcode-block" id="DEMS.create_dem">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.create_dem">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_dem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create Digital Elevation Model (DEM) from AHN data with optional building and overbrugginsdeel data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            bbox (tuple):       Bounding box coordinates (xmin, ymin, xmax, ymax).</span>

<span class="sd">        Returns:</span>
<span class="sd">            cropped_dtm (np.ndarray):   Filled, cropped DTM array.</span>
<span class="sd">            cropped_dsm (np.ndarray):   Cropped DSM array with buildings and building heights, optional output.</span>
<span class="sd">            transform (Affine):   Affine transform matrix of the rasters.</span>
<span class="sd">         &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="c1"># --- Fetch DTM ---</span>
        <span class="n">dtm_dst</span><span class="p">,</span> <span class="n">dtm_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_ahn_wcs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bufferbbox</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;output/dtm_fetched.tif&quot;</span><span class="p">,</span> <span class="n">coverage</span><span class="o">=</span><span class="s2">&quot;dtm_05m&quot;</span><span class="p">,</span> <span class="n">wcs_resolution</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">dtm_dst</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">filled_dtm</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_raster</span><span class="p">(</span><span class="n">dtm_array</span><span class="p">,</span> <span class="n">dtm_dst</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>

        <span class="c1"># --- Fetch DSM if buildings are used ---</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">building_data</span><span class="p">:</span>
            <span class="n">dsm_dst</span><span class="p">,</span> <span class="n">dsm_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_ahn_wcs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bufferbbox</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;output/dsm_fetched.tif&quot;</span><span class="p">,</span> <span class="n">coverage</span><span class="o">=</span><span class="s2">&quot;dsm_05m&quot;</span><span class="p">,</span> <span class="n">wcs_resolution</span><span class="o">=</span><span class="mf">0.5</span>
            <span class="p">)</span>
            <span class="n">filled_dsm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_raster</span><span class="p">(</span><span class="n">dsm_array</span><span class="p">,</span> <span class="n">dsm_dst</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>
            <span class="n">final_dsm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_buildings</span><span class="p">(</span>
                <span class="n">filled_dtm</span><span class="p">,</span> <span class="n">filled_dsm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">building_data</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_dsm</span> <span class="o">=</span> <span class="n">filled_dtm</span>
        <span class="c1"># --- Resample if needed ---</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">!=</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">filled_dtm</span><span class="p">,</span> <span class="n">resamp_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_raster</span><span class="p">(</span>
                <span class="n">filled_dtm</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">dtm_dst</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">final_dsm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_dsm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_raster</span><span class="p">(</span>
                    <span class="n">final_dsm</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">dtm_dst</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
                <span class="p">)</span>

            <span class="n">transform</span> <span class="o">=</span> <span class="n">resamp_transform</span>

        <span class="c1"># --- Crop the arrays to the bounding box after interpolation ---</span>
        <span class="n">cropped_dtm</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_to_bbox</span><span class="p">(</span><span class="n">filled_dtm</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">final_dsm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cropped_dsm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_to_bbox</span><span class="p">(</span><span class="n">final_dsm</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>

        <span class="c1"># --- Write outputs ---</span>
        <span class="n">write_output</span><span class="p">(</span><span class="n">dtm_dst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">cropped_dtm</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/final_dtm.tif&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">final_dsm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">write_output</span><span class="p">(</span><span class="n">dtm_dst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">cropped_dsm</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/final_dsm.tif&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cropped_dtm</span><span class="p">,</span> <span class="n">cropped_dsm</span> <span class="k">if</span> <span class="n">final_dsm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cropped_dtm</span><span class="p">,</span> <span class="n">transform</span></div>


<div class="viewcode-block" id="DEMS.update_dsm">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.update_dsm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_dsm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_buildings</span><span class="p">,</span> <span class="n">user_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_arrays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">higher_buildings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the DSM with new user building heights, supporting both 2D and 3D DSM arrays.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            user_buildings (list):                          List of user building data dictionaries with geometries.</span>
<span class="sd">            user_array (np.ndarray, optional):              Single 2D array with building height data.</span>
<span class="sd">            user_arrays (list of np.ndarray, optional):     List of arrays representing multiple DSM layers.</span>
<span class="sd">            higher_buildings (list, optional):              List of user buildings with additional height layers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span> <span class="o">=</span> <span class="n">user_arrays</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_arrays</span><span class="p">))]</span>

        <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">user_buildings</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">building</span><span class="p">:</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="n">geometry_mask</span><span class="p">([</span><span class="n">geom</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="c1"># Find the minimum value within the mask</span>
                <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_array</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">min_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">min_value</span>

                    <span class="k">if</span> <span class="n">higher_buildings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_build</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">higher_buildings</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">building</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]),</span>
                            <span class="kc">None</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">new_build</span> <span class="ow">and</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">new_build</span><span class="p">:</span>
                            <span class="n">new_geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">new_build</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span>
                            <span class="n">new_mask</span> <span class="o">=</span> <span class="n">geometry_mask</span><span class="p">([</span><span class="n">new_geom</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">out_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_arrays</span><span class="p">)):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">new_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_arrays</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">new_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">min_value</span></div>


<div class="viewcode-block" id="DEMS.remove_buildings">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.remove_buildings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_buildings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove_list</span><span class="p">,</span> <span class="n">remove_user_list</span><span class="p">,</span> <span class="n">building_data</span><span class="p">,</span> <span class="n">user_building_data</span><span class="p">,</span> <span class="n">user_buildings_higher</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Remove specified buildings from DSM by replacing their areas with DTM values.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            remove_list (list):                         List of parcel IDs to remove from the main building dataset.</span>
<span class="sd">            remove_user_list (list):                    List of parcel IDs to remove from the user building dataset.</span>
<span class="sd">            building_data (list):                       List of main building data dictionaries.</span>
<span class="sd">            user_building_data (list):                  List of user building data dictionaries.</span>
<span class="sd">            user_buildings_higher (list, optional):     List of user buildings with higher layers to be removed as well.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">remove_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">remove_list</span><span class="p">)</span>
        <span class="n">remove_user_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">remove_user_list</span><span class="p">)</span>
        <span class="c1"># Find buildings to remove from both datasets</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">building</span> <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">building_data</span> <span class="k">if</span> <span class="n">building</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">remove_set</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parcel IDs being checked (to_remove):&quot;</span><span class="p">,</span>
              <span class="p">[</span><span class="n">building</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">building_data</span><span class="p">])</span>

        <span class="n">to_remove_user</span> <span class="o">=</span> <span class="p">[</span><span class="n">building</span> <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">user_building_data</span> <span class="k">if</span> <span class="n">building</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">remove_user_set</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parcel IDs being checked (to_remove_user):&quot;</span><span class="p">,</span>
              <span class="p">[</span><span class="n">building</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">user_building_data</span><span class="p">])</span>

        <span class="n">remove_all</span> <span class="o">=</span> <span class="n">to_remove</span> <span class="o">+</span> <span class="n">to_remove_user</span>

        <span class="c1"># Extract geometries for mask creation</span>
        <span class="n">geometries</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">remove_all</span> <span class="k">if</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">building</span><span class="p">]</span>

        <span class="c1"># Create the removal mask if there are geometries</span>
        <span class="k">if</span> <span class="n">geometries</span><span class="p">:</span>
            <span class="n">remove_building_mask</span> <span class="o">=</span> <span class="n">geometry_mask</span><span class="p">(</span><span class="n">geometries</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                 <span class="n">out_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">remove_building_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">remove_building_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">user_buildings_higher</span><span class="p">:</span>
                    <span class="n">remove_other_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">building</span> <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">user_buildings_higher</span> <span class="k">if</span>
                                           <span class="n">building</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">remove_user_set</span><span class="p">]</span>
                    <span class="n">other_geometries</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">remove_other_layers</span> <span class="k">if</span>
                                        <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">building</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">other_geometries</span><span class="p">:</span>
                        <span class="n">remove_others_mask</span> <span class="o">=</span> <span class="n">geometry_mask</span><span class="p">(</span><span class="n">other_geometries</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                           <span class="n">out_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">)):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">remove_others_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span></div>


<div class="viewcode-block" id="DEMS.update_building_height">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.update_building_height">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_building_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_height</span><span class="p">,</span> <span class="n">user_buildings</span><span class="p">,</span> <span class="n">building_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_arrays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">higher_buildings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Raise the height of specified user building(s) in the DSM by a given amount.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            raise_height (float):                           Amount to raise the building height.</span>
<span class="sd">            user_buildings (list):                          List of user building data dictionaries.</span>
<span class="sd">            building_id (str, optional):                    ID of the building to raise. If None, raise_all should be used.</span>
<span class="sd">            user_array (np.ndarray, optional):              Single 2D array with building height data.</span>
<span class="sd">            user_arrays (list of np.ndarray, optional):     List of arrays representing multiple DSM layers.</span>
<span class="sd">            higher_buildings (list, optional):              List of buildings with additional height layers for 3D DSM.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">building_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">matching_buildings</span> <span class="o">=</span> <span class="p">[</span><span class="n">building</span> <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">user_buildings</span> <span class="k">if</span> <span class="n">building</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">building_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">matching_buildings</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">building</span><span class="p">:</span>
                    <span class="n">geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>

                    <span class="n">mask</span> <span class="o">=</span> <span class="n">geometry_mask</span><span class="p">([</span><span class="n">geom</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">+=</span> <span class="n">raise_height</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">+=</span> <span class="n">raise_height</span>
                    <span class="k">if</span> <span class="n">higher_buildings</span><span class="p">:</span>
                        <span class="n">new_build</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">higher_buildings</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">building</span><span class="p">[</span><span class="s1">&#39;parcel_id&#39;</span><span class="p">]),</span>
                            <span class="kc">None</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">new_build</span> <span class="ow">and</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">new_build</span><span class="p">:</span>
                            <span class="n">new_geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">new_build</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span>
                            <span class="n">new_mask</span> <span class="o">=</span> <span class="n">geometry_mask</span><span class="p">([</span><span class="n">new_geom</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">out_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_arrays</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">new_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="n">raise_height</span></div>


<div class="viewcode-block" id="DEMS.export_context">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.DEMS.export_context">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">export_format</span><span class="o">=</span><span class="s2">&quot;dxf&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Export buildings and DSM bounding box to a CAD-compatible file format.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name (str):                        Path and name of the file to export.</span>
<span class="sd">            export_format (str, optional):          Export format. Options: &#39;json&#39;, &#39;csv&#39;, or &#39;dxf&#39;. Defaults to &#39;dxf&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">])</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">bbox</span>

        <span class="c1"># Normalize bounding box where (0,0) is at lower-left</span>
        <span class="n">normalized_bbox</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ymin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">,</span>
            <span class="s2">&quot;ymax&quot;</span><span class="p">:</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
        <span class="p">}</span>

        <span class="c1"># Normalize building geometries</span>
        <span class="n">transformed_buildings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">building_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">in</span> <span class="n">building</span><span class="p">:</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span>
                <span class="n">shifted_geom</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">xoff</span><span class="o">=-</span><span class="n">xmin</span><span class="p">,</span> <span class="n">yoff</span><span class="o">=-</span><span class="n">ymin</span><span class="p">)</span>

                <span class="n">transformed_buildings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">shifted_geom</span><span class="p">),</span>
                    <span class="s2">&quot;parcel_id&quot;</span><span class="p">:</span> <span class="n">building</span><span class="p">[</span><span class="s2">&quot;parcel_id&quot;</span><span class="p">]</span>
                <span class="p">})</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dsm_bbox&quot;</span><span class="p">:</span> <span class="n">normalized_bbox</span><span class="p">,</span>
            <span class="s2">&quot;buildings&quot;</span><span class="p">:</span> <span class="n">transformed_buildings</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">export_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exported data to </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">export_format</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;parcel_id&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">transformed_buildings</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">building</span><span class="p">[</span><span class="s2">&quot;parcel_id&quot;</span><span class="p">],</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exported data to </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">export_format</span> <span class="o">==</span> <span class="s2">&quot;dxf&quot;</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">ezdxf</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
            <span class="n">msp</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">modelspace</span><span class="p">()</span>

            <span class="c1"># Add bounding box as a rectangle</span>
            <span class="n">msp</span><span class="o">.</span><span class="n">add_lwpolyline</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">normalized_bbox</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                                <span class="p">(</span><span class="n">normalized_bbox</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">],</span> <span class="n">normalized_bbox</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">normalized_bbox</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">])],</span>
                               <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Add buildings as polylines</span>
            <span class="k">for</span> <span class="n">building</span> <span class="ow">in</span> <span class="n">transformed_buildings</span><span class="p">:</span>
                <span class="n">poly</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">poly</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">:</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
                    <span class="n">msp</span><span class="o">.</span><span class="n">add_lwpolyline</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">doc</span><span class="o">.</span><span class="n">saveas</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exported data to </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unsupported export format. Use &#39;json&#39;, &#39;csv&#39;, or &#39;dxf&#39;.&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CHM">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CHM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class for creating and managing Canopy Height Models (CHMs) from LiDAR data.</span>
<span class="sd">    This class handles downloading and merging LAS/LAZ tiles, filtering vegetation points</span>
<span class="sd">    based on classification and NDVI, rasterizing vegetation using interpolation, applying</span>
<span class="sd">    smoothing filters, and generating final CHM raster outputs.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        bbox (tuple):               Bounding box coordinates (min_x, min_y, max_x, max_y) defining the area of interest.</span>
<span class="sd">        bufferedbbox (tuple):       Buffered bounding box extended by a fixed margin.</span>
<span class="sd">        crs (rasterio.crs.CRS):                         Coordinate reference system used (default EPSG:28992).</span>
<span class="sd">        dtm (numpy.ndarray or rasterio object):         Digital Terrain Model raster data.</span>
<span class="sd">        dsm (numpy.ndarray or rasterio object):         Digital Surface Model raster data.</span>
<span class="sd">        output_folder_chm (str):                        Folder path where CHM outputs are saved.</span>
<span class="sd">        gdf (geopandas.GeoDataFrame):                   GeoDataFrame containing tile lookup information.</span>
<span class="sd">        chm (numpy.ndarray):                            Initial Canopy Height Model raster array.</span>
<span class="sd">        tree_polygons (geopandas.GeoDataFrame):         Polygons representing tree footprints.</span>
<span class="sd">        transform (affine.Affine):                      Affine transform for raster coordinates.</span>
<span class="sd">        trunk_array (numpy.ndarray):                    Array representing estimated trunk heights.</span>
<span class="sd">        original_chm (numpy.ndarray):                   Copy of the original CHM before processing.</span>
<span class="sd">        og_polygons (geopandas.GeoDataFrame):           Copy of original tree polygons.</span>
<span class="sd">        original_trunk (numpy.ndarray):                 Copy of original trunk array.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">dtm</span><span class="p">,</span> <span class="n">dsm</span><span class="p">,</span> <span class="n">trunk_height</span><span class="p">,</span> <span class="n">output_folder_chm</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">output_folder_las</span><span class="o">=</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">merged_output</span><span class="o">=</span><span class="s1">&#39;pointcloud.las&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize the CHM class with bounding box, DTM, DSM, trunk height and folder paths.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            bbox (tuple):                                     Bounding box as (min_x, min_y, max_x, max_y).</span>
<span class="sd">            dtm (numpy.ndarray or rasterio dataset):          Digital Terrain Model raster.</span>
<span class="sd">            dsm (numpy.ndarray or rasterio dataset):          Digital Surface Model raster.</span>
<span class="sd">            trunk_height (float):                             Factor or scalar to multiply the CHM for trunk height approximation.</span>
<span class="sd">            output_folder_las (str):                          Folder path for output LAS files.</span>
<span class="sd">            input_folder (str):                               Folder path for input files.</span>
<span class="sd">            output_folder_chm (str):                          Folder path for CHM-specific output.</span>
<span class="sd">            resolution (float, optional):                     Resolution for raster grid cells. Defaults to 0.5.</span>
<span class="sd">            merged_output (str, optional):                    Filename for merged LAS output. Defaults to &#39;pointcloud.las&#39;.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bufferedbbox</span> <span class="o">=</span> <span class="n">edit_bounds</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="p">(</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="mi">28992</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtm</span> <span class="o">=</span> <span class="n">dtm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span> <span class="o">=</span> <span class="n">dsm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_folder_chm</span> <span class="o">=</span> <span class="n">output_folder_chm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;src/j_dataprep/geotiles/AHN_lookup.geojson&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_polygons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_chm</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="n">output_folder_las</span><span class="p">,</span> <span class="n">input_folder</span><span class="o">=</span><span class="n">output_folder_las</span><span class="p">,</span> <span class="n">merged_output</span><span class="o">=</span><span class="n">merged_output</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trunk_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chm</span> <span class="o">*</span> <span class="n">trunk_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_chm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">og_polygons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_trunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_polygons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trunk_array</span>

<div class="viewcode-block" id="CHM.save_las">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.save_las">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_las</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merged_las</span><span class="p">,</span> <span class="n">veg_points</span><span class="p">,</span> <span class="n">output_name</span><span class="o">=</span><span class="s2">&quot;veg_points.las&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Save filtered vegetation points as a LAS file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            merged_las (laspy.LasData):     Original merged LAS data with header info.</span>
<span class="sd">            veg_points (laspy.LasData):     Filtered LAS points representing vegetation.</span>
<span class="sd">            output_name (str, optional):    Output filename. Defaults to &quot;veg_points.las&quot;.</span>

<span class="sd">        Creates the output folder if it does not exist and writes the LAS file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Create a new LasData object with the same header and filtered points</span>
        <span class="n">vegetation_las</span> <span class="o">=</span> <span class="n">laspy</span><span class="o">.</span><span class="n">LasData</span><span class="p">(</span><span class="n">merged_las</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="n">vegetation_las</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">veg_points</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Save to file</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder_chm</span><span class="p">,</span> <span class="n">output_name</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder_chm</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vegetation_las</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved vegetation points to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CHM.find_tiles">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.find_tiles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find geotile names overlapping the specified bounding box.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x_min, y_min, x_max, y_max (float):       Coordinates defining the bounding box.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]:                           List of geotile names that intersect with the bounding box.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">query_geom</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gdf</span><span class="o">.</span><span class="n">sindex</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">query_geom</span><span class="p">)</span>  <span class="c1"># predicate=&quot;overlaps&quot;: tricky i want to still get something if it is all contained in one</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">matches</span><span class="p">][</span><span class="s2">&quot;GT_AHNSUB&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>


<div class="viewcode-block" id="CHM.filter_points_within_bounds">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.filter_points_within_bounds">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_points_within_bounds</span><span class="p">(</span><span class="n">las_data</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Filter LAS points that lie within the given bounding box.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            las_data (laspy.LasData):   Input LAS point cloud.</span>
<span class="sd">            bounds (tuple):             Bounding box as (x_min, y_min, x_max, y_max).</span>

<span class="sd">        Returns:</span>
<span class="sd">            laspy.LasData:              Filtered LAS data containing only points within bounds.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">las_data</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">las_data</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">las_data</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">las_data</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">las_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>


    <span class="c1"># @staticmethod</span>
<div class="viewcode-block" id="CHM.extract_vegetation_points">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.extract_vegetation_points">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_vegetation_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LasData</span><span class="p">,</span> <span class="n">ndvi_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">pre_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extract vegetation points based on classification and NDVI threshold.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - LasData (laspy.LasData):          Input LAS point cloud data.</span>
<span class="sd">        - ndvi_threshold (float, optional): NDVI cutoff for vegetation points. Defaults to 0.1.</span>
<span class="sd">        - pre_filter (bool, optional):      If True, filter out vegetation points below 1.5m above lowest vegetation point. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - veg_points (laspy.LasData):       LAS data filtered to vegetation points based on NDVI and optional height filtering.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Filter points based on classification (vegetation-related classes), note: vegetation classes are empty in AHN4</span>
        <span class="n">possible_vegetation_points</span> <span class="o">=</span> <span class="n">LasData</span><span class="p">[(</span><span class="n">LasData</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># Unclassified</span>
                                             <span class="p">(</span><span class="n">LasData</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># Low vegetation</span>
                                             <span class="p">(</span><span class="n">LasData</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># Medium vegetation</span>
                                             <span class="p">(</span><span class="n">LasData</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)]</span>  <span class="c1"># High vegetation</span>

        <span class="c1"># Calculate NDVI</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">possible_vegetation_points</span><span class="o">.</span><span class="n">red</span>
        <span class="n">nir</span> <span class="o">=</span> <span class="n">possible_vegetation_points</span><span class="o">.</span><span class="n">nir</span>
        <span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="n">red</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">red</span><span class="p">)</span>

        <span class="c1"># Filter the points whose NDVI is greater than the threshold</span>
        <span class="n">veg_points</span> <span class="o">=</span> <span class="n">possible_vegetation_points</span><span class="p">[</span><span class="n">ndvi</span> <span class="o">&gt;</span> <span class="n">ndvi_threshold</span><span class="p">]</span>

        <span class="c1"># Option: already filter away the points with a height below 1.5m from the lowest veg point, introduced because</span>
        <span class="c1"># of one very large tile (25GN2_24.LAZ)</span>
        <span class="k">if</span> <span class="n">pre_filter</span><span class="p">:</span>
            <span class="n">heights</span> <span class="o">=</span> <span class="n">veg_points</span><span class="o">.</span><span class="n">z</span>
            <span class="n">min_height</span> <span class="o">=</span> <span class="n">heights</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="c1"># Filter out points with heights between the minimum height and 1.5 meters</span>
            <span class="n">filtered_veg_points</span> <span class="o">=</span> <span class="n">veg_points</span><span class="p">[(</span><span class="n">heights</span> <span class="o">&lt;=</span> <span class="n">min_height</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">heights</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">filtered_veg_points</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_las</span><span class="p">(</span><span class="n">LasData</span><span class="p">,</span> <span class="n">veg_points</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">veg_points</span></div>


<div class="viewcode-block" id="CHM.raster_center_coords">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.raster_center_coords">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">raster_center_coords</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute center coordinates of each cell in a raster grid.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            min_x, max_x, min_y, max_y (float):  Bounding box coordinates.</span>
<span class="sd">            resolution (float):                 Cell size; assumed square cells.</span>

<span class="sd">        Returns:</span>
<span class="sd">            grid_center_x (np.ndarray)      X cell center coordinates.</span>
<span class="sd">            grid_center_y (np.ndarray):     Y cell center coordinates.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># create coordinates for the x and y border of every cell.</span>
        <span class="n">x_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>  <span class="c1"># x coordinates expand from left to right.</span>
        <span class="n">y_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_y</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="o">-</span><span class="n">resolution</span><span class="p">)</span>  <span class="c1"># y coordinates reduce from top to bottom.</span>

        <span class="c1"># create center point coordinates for evey cell.</span>
        <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">)</span>
        <span class="n">grid_center_x</span> <span class="o">=</span> <span class="n">grid_x</span> <span class="o">+</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">grid_center_y</span> <span class="o">=</span> <span class="n">grid_y</span> <span class="o">-</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">grid_center_x</span><span class="p">,</span> <span class="n">grid_center_y</span></div>


<div class="viewcode-block" id="CHM.median_filter_chm">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.median_filter_chm">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">median_filter_chm</span><span class="p">(</span><span class="n">chm_array</span><span class="p">,</span> <span class="n">nodata_value</span><span class="o">=-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Apply a median filter to smooth the CHM, preserving NoData areas.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            chm_array (np.ndarray):         CHM raster array.</span>
<span class="sd">            nodata_value (float, optional): NoData value in the array. Defaults to -9999.</span>
<span class="sd">            size (int, optional):           Median filter size (window). Defaults to 3.</span>

<span class="sd">        Returns:</span>
<span class="sd">            smoothed_chm (np.ndarray):      Smoothed CHM array with NoData preserved.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Create a mask for valid data</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">chm_array</span> <span class="o">!=</span> <span class="n">nodata_value</span>

        <span class="c1"># Pad the data with nodata_value</span>
        <span class="n">pad_width</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">padded_chm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">chm_array</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">nodata_value</span><span class="p">)</span>

        <span class="c1"># Apply median filter to padded data</span>
        <span class="n">filtered_padded</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">padded_chm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="c1"># median_filter(padded_chm.astype(np.float32), size=size)</span>

        <span class="c1"># Remove padding</span>
        <span class="n">smoothed_chm</span> <span class="o">=</span> <span class="n">filtered_padded</span><span class="p">[</span><span class="n">pad_width</span><span class="p">:</span><span class="o">-</span><span class="n">pad_width</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">:</span><span class="o">-</span><span class="n">pad_width</span><span class="p">]</span>

        <span class="c1"># Only keep valid data in smoothed result</span>
        <span class="n">smoothed_chm</span><span class="p">[</span><span class="o">~</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodata_value</span>

        <span class="k">return</span> <span class="n">smoothed_chm</span></div>


<div class="viewcode-block" id="CHM.interpolation_vegetation">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.interpolation_vegetation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">interpolation_vegetation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veg_points</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">no_data_value</span><span class="o">=-</span><span class="mi">9999</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a vegetation raster by interpolating vegetation points using Laplace interpolation.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            veg_points (laspy.LasData):       Vegetation points to interpolate.</span>
<span class="sd">            resolution (float):               Desired raster resolution.</span>
<span class="sd">            no_data_value (int, optional):    Value to assign NoData cells. Defaults to -9999.</span>

<span class="sd">        Returns:</span>
<span class="sd">            interpolated_grid (np.ndarray):           Raster grid with interpolated vegetation heights.</span>
<span class="sd">            grid_center_xy (tuple of np.ndarray):  Grid center coordinates (x, y).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># bounding box extents minus 0.5 resolution of AHN dataset</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span>

        <span class="c1"># Define size of the region</span>
        <span class="n">x_length</span> <span class="o">=</span> <span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span>
        <span class="n">y_length</span> <span class="o">=</span> <span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span>

        <span class="c1"># Number of rows and columns</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_length</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">y_length</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">)</span>

        <span class="c1"># Initialize raster grid</span>
        <span class="n">veg_raster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">no_data_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Calculate center coords for each grid cell</span>
        <span class="n">grid_center_xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_center_coords</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">veg_points</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no vegetation points in the current area.&quot;</span><span class="p">)</span>
            <span class="n">veg_raster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">veg_raster</span><span class="p">,</span> <span class="n">grid_center_xy</span>

        <span class="c1"># create the delaunay triangulation</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">startinpy</span><span class="o">.</span><span class="n">DT</span><span class="p">()</span>
        <span class="n">dt</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">veg_points</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="s2">&quot;BBox&quot;</span><span class="p">)</span>

        <span class="c1"># Flatten the grid to get a list of all center coords</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">grid_center_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">grid_center_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>

        <span class="n">vegetation_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">veg_points</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">veg_points</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">vegetation_points</span><span class="p">)</span>

        <span class="c1"># Find the distance to the nearest vegetation point for each grid cell</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">distance_threshold</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># masking cells that exceed threshold</span>
        <span class="n">within_threshold_mask</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">&lt;=</span> <span class="n">distance_threshold</span>
        <span class="c1"># Interpolation only for those near</span>
        <span class="n">valid_locs</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">within_threshold_mask</span><span class="p">]</span>

        <span class="c1"># laplace interpolation</span>
        <span class="n">interpolated_values</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">interpolate</span><span class="p">({</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;Laplace&quot;</span><span class="p">},</span> <span class="n">valid_locs</span><span class="p">)</span>

        <span class="c1"># reshape interpolated grid back to og</span>
        <span class="n">interpolated_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">veg_raster</span><span class="p">,</span> <span class="n">no_data_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># Start with no_data</span>
        <span class="n">interpolated_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">within_threshold_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolated_values</span>

        <span class="k">return</span> <span class="n">interpolated_grid</span><span class="p">,</span> <span class="n">grid_center_xy</span></div>


<div class="viewcode-block" id="CHM.download_las_tiles">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.download_las_tiles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_las_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matching_tiles</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Download AHN5 or AHN4 LAZ tiles based on a list of matching tile names.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            matching_tiles (list of str):       List of tile identifiers (e.g., &#39;31FN2_01&#39;) to be downloaded.</span>
<span class="sd">            output_folder (str):                Directory where downloaded LAZ files will be saved.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">base_url_ahn5</span> <span class="o">=</span> <span class="s2">&quot;https://geotiles.citg.tudelft.nl/AHN5_T&quot;</span>
        <span class="n">base_url_ahn4</span> <span class="o">=</span> <span class="s2">&quot;https://geotiles.citg.tudelft.nl/AHN4_T&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">full_tile_name</span> <span class="ow">in</span> <span class="n">matching_tiles</span><span class="p">:</span>
            <span class="c1"># Extract tile name and sub-tile number</span>
            <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">full_tile_name</span><span class="p">:</span>
                <span class="n">tile_name</span><span class="p">,</span> <span class="n">sub_tile</span> <span class="o">=</span> <span class="n">full_tile_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping invalid tile entry: </span><span class="si">{</span><span class="n">full_tile_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">sub_tile_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">sub_tile</span><span class="p">)</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tile_name</span><span class="si">}{</span><span class="n">sub_tile_str</span><span class="si">}</span><span class="s2">.LAZ&quot;</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># Skip if already downloaded</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> already exists, skipping download.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Try AHN5</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url_ahn5</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded from AHN5 and saved </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AHN5 download failed for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># AHN4 fallback</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url_ahn4</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded from AHN4 and saved </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AHN4 download also failed for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CHM.merge_las_files">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.merge_las_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_las_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">laz_files</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">merged_output</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Merge and crop multiple LAZ files into a single LAS file within the specified bounds.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            laz_files (list of str):        Paths to the input LAZ files.</span>
<span class="sd">            bounds (tuple):                 Bounding box (xmin, ymin, xmax, ymax) to crop point clouds.</span>
<span class="sd">            merged_output (str or Path):    File path to write the merged output LAS file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            laspy.LasData:                  Merged and cropped point cloud data.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">merged_output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">merged_output</span><span class="p">)</span>

        <span class="n">las_merged</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">all_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">merged_scales</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">merged_offset</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">merged_output</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">laspy</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">merged_output</span><span class="p">)</span> <span class="k">as</span> <span class="n">las</span><span class="p">:</span>
                <span class="n">las_merged</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">las_merged</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">laz_files</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">laspy</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">las</span><span class="p">:</span>
                <span class="n">las_data</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">cropped_las</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_points_within_bounds</span><span class="p">(</span><span class="n">las_data</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">las_merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Initialize merged LAS file using the first input file</span>
                    <span class="n">las_merged</span> <span class="o">=</span> <span class="n">laspy</span><span class="o">.</span><span class="n">LasData</span><span class="p">(</span><span class="n">las_data</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                    <span class="n">las_merged</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">cropped_las</span><span class="o">.</span><span class="n">points</span>

                    <span class="n">merged_scales</span> <span class="o">=</span> <span class="n">las_merged</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">scales</span>
                    <span class="n">merged_offset</span> <span class="o">=</span> <span class="n">las_merged</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">offset</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="n">scale</span> <span class="o">=</span> <span class="n">las_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">scales</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">las_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">offsets</span>
                    <span class="c1"># Convert integer coordinates to real-world values &amp; Transform into merged coordinate system</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="p">((</span><span class="n">cropped_las</span><span class="o">.</span><span class="n">X</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">merged_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">merged_scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_y</span> <span class="o">=</span> <span class="p">((</span><span class="n">cropped_las</span><span class="o">.</span><span class="n">Y</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">merged_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">merged_scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">new_z</span> <span class="o">=</span> <span class="p">((</span><span class="n">cropped_las</span><span class="o">.</span><span class="n">Z</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">merged_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">merged_scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="c1"># Copy points and update X, Y, Z</span>
                    <span class="n">new_points</span> <span class="o">=</span> <span class="n">cropped_las</span><span class="o">.</span><span class="n">points</span>
                    <span class="n">new_points</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                    <span class="n">new_points</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                    <span class="n">new_points</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_z</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

                    <span class="n">all_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_points</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>

                    <span class="c1"># Final merge step</span>
        <span class="k">if</span> <span class="n">las_merged</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">all_points</span><span class="p">:</span>
                <span class="n">all_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">las_merged</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>

                <span class="n">merged_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">las_merged</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">laspy</span><span class="o">.</span><span class="n">ScaleAwarePointRecord</span><span class="p">(</span><span class="n">merged_array</span><span class="p">,</span> <span class="n">las_merged</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">point_format</span><span class="p">,</span>
                                                                <span class="n">las_merged</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">scales</span><span class="p">,</span> <span class="n">las_merged</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">offsets</span><span class="p">)</span>

            <span class="n">las_merged</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">merged_output</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">las_merged</span></div>


<div class="viewcode-block" id="CHM.chm_finish">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.chm_finish">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chm_finish</span><span class="p">(</span><span class="n">chm_array</span><span class="p">,</span> <span class="n">dtm_array</span><span class="p">,</span>
                   <span class="n">dsm_array</span><span class="p">,</span> <span class="n">min_height</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_height</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finalize CHM by removing terrain and filtering by vegetation height.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            chm_array (np.ndarray):     Initial canopy height model array.</span>
<span class="sd">            dtm_array (np.ndarray):     Digital terrain model array.</span>
<span class="sd">            dsm_array (np.ndarray):     Digital surface model array.</span>
<span class="sd">            min_height (float):         Minimum height threshold to keep vegetation (default = 2).</span>
<span class="sd">            max_height (float):         Maximum height threshold to keep vegetation (default = 40).</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Processed CHM with invalid or noisy values removed.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">result_array</span> <span class="o">=</span> <span class="n">chm_array</span> <span class="o">-</span> <span class="n">dtm_array</span>
        <span class="n">result_array</span><span class="p">[(</span><span class="n">chm_array</span> <span class="o">-</span> <span class="n">dsm_array</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">result_array</span><span class="p">[(</span><span class="n">result_array</span> <span class="o">&lt;</span> <span class="n">min_height</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">result_array</span> <span class="o">&gt;</span> <span class="n">max_height</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">result_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result_array</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">result_array</span></div>


<div class="viewcode-block" id="CHM.chm_creation">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.chm_creation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">chm_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LasData</span><span class="p">,</span> <span class="n">vegetation_data</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nodata_value</span><span class="o">=-</span><span class="mi">9999</span><span class="p">,</span>
                     <span class="n">filter_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create and optionally smooth a CHM from vegetation data, then save it as a GeoTIFF and extract tree polygons.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            LasData (laspy.LasData):    LAS metadata for writing the output raster.</span>
<span class="sd">            vegetation_data (tuple):    Tuple of (veg_raster, grid_centers) for CHM generation.</span>
<span class="sd">            output_filename (str):      Path to save the output CHM raster.</span>
<span class="sd">            resolution (float):         Spatial resolution of the raster (default = 0.5).</span>
<span class="sd">            smooth (bool):              Whether to apply a median filter to the CHM (default = False).</span>
<span class="sd">            nodata_value (float):       Value to assign to NoData cells in the raster (default = -9999).</span>
<span class="sd">            filter_size (int):          Size of median filter kernel (default = 3).</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (chm_array, polygons, transform) where polygons are tree regions as GeoJSON-like dicts.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">veg_raster</span> <span class="o">=</span> <span class="n">vegetation_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grid_centers</span> <span class="o">=</span> <span class="n">vegetation_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">top_left_x</span> <span class="o">=</span> <span class="n">grid_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">top_left_y</span> <span class="o">=</span> <span class="n">grid_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">top_left_x</span><span class="p">,</span> <span class="n">top_left_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="o">-</span><span class="n">resolution</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
            <span class="n">veg_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">median_filter_chm</span><span class="p">(</span><span class="n">veg_raster</span><span class="p">,</span> <span class="n">nodata_value</span><span class="o">=</span><span class="n">nodata_value</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">filter_size</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">veg_raster</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">veg_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chm_finish</span><span class="p">(</span><span class="n">veg_raster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsm</span><span class="p">)</span>

        <span class="n">write_output</span><span class="p">(</span><span class="n">LasData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">veg_raster</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># create the polygons</span>
        <span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_clusters</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">veg_raster</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">shapes_gen</span> <span class="o">=</span> <span class="n">shapes</span><span class="p">(</span><span class="n">labeled_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">labeled_array</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">polygons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span> <span class="s2">&quot;polygon_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span>
            <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">shapes_gen</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">veg_raster</span><span class="p">,</span> <span class="n">polygons</span><span class="p">,</span> <span class="n">transform</span></div>


<div class="viewcode-block" id="CHM.init_chm">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.init_chm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_chm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">input_folder</span><span class="o">=</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span>  <span class="n">merged_output</span><span class="o">=</span><span class="s2">&quot;output/pointcloud.las&quot;</span><span class="p">,</span>  <span class="n">smooth_chm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ndvi_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize and generate a CHM by downloading, merging, filtering, and interpolating LiDAR data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            bbox (tuple):           Bounding box (xmin, ymin, xmax, ymax) for the area of interest.</span>
<span class="sd">            output_folder (str):    Directory for saving output files (default = &#39;output&#39;).</span>
<span class="sd">            input_folder (str):     Directory where LAZ files are stored or downloaded (default = &#39;temp&#39;).</span>
<span class="sd">            merged_output (str):    Path to save the merged LAS point cloud (default = &#39;output/pointcloud.las&#39;).</span>
<span class="sd">            smooth_chm (bool):      Whether to smooth the CHM using a median filter (default = True).</span>
<span class="sd">            resolution (float):     Output raster resolution (default = 0.5).</span>
<span class="sd">            ndvi_threshold (float): NDVI threshold for filtering vegetation points (default = 0.05).</span>
<span class="sd">            filter_size (int):      Size of median filter kernel (default = 3).</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (chm_array, polygons, transform) or (None, None, None) if process fails.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">matching_tiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_tiles</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bufferedbbox</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tiles covering the area:&quot;</span><span class="p">,</span> <span class="n">matching_tiles</span><span class="p">)</span>

        <span class="n">existing_tiles</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.LAZ&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">missing_tiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">tile</span> <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">matching_tiles</span> <span class="k">if</span> <span class="n">tile</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_tiles</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">missing_tiles</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing tiles:&quot;</span><span class="p">,</span> <span class="n">missing_tiles</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_las_tiles</span><span class="p">(</span><span class="n">missing_tiles</span><span class="p">,</span> <span class="n">input_folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>

        <span class="n">laz_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.LAZ&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">matching_tiles</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">laz_files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No relevant LAZ files found in the input folder or its subfolders.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">las_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_las_files</span><span class="p">(</span><span class="n">laz_files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bufferedbbox</span><span class="p">,</span> <span class="n">merged_output</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">las_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid points found in the given boundary.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Extract vegetation points</span>
        <span class="n">veg_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_vegetation_points</span><span class="p">(</span><span class="n">las_data</span><span class="p">,</span> <span class="n">ndvi_threshold</span><span class="o">=</span><span class="n">ndvi_threshold</span><span class="p">,</span> <span class="n">pre_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">vegetation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_vegetation</span><span class="p">(</span><span class="n">veg_points</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder_chm</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CHM.TIF&quot;</span><span class="p">)</span>

        <span class="c1"># Create the CHM and save it</span>
        <span class="n">chm</span><span class="p">,</span> <span class="n">polygons</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chm_creation</span><span class="p">(</span><span class="n">las_data</span><span class="p">,</span> <span class="n">vegetation_data</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth_chm</span><span class="p">,</span> <span class="n">nodata_value</span><span class="o">=-</span><span class="mi">9999</span><span class="p">,</span>
                     <span class="n">filter_size</span><span class="o">=</span><span class="n">filter_size</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chm</span><span class="p">,</span> <span class="n">polygons</span><span class="p">,</span> <span class="n">transform</span></div>


<div class="viewcode-block" id="CHM.remove_trees">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.remove_trees">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Remove a tree (or cluster of trees) from the CHM and trunk arrays by polygon ID.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            tree_id (int): Identifier of the tree polygon to remove.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">target_polygons</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_polygons</span> <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="s2">&quot;polygon_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tree_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_polygons</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No trees found with ID: </span><span class="si">{</span><span class="n">tree_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">tree_mask</span> <span class="o">=</span> <span class="n">geometry_mask</span><span class="p">(</span>
            <span class="n">geometries</span><span class="o">=</span><span class="n">target_polygons</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">out_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="o">.</span><span class="n">shape</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_mask</span> <span class="o">=</span> <span class="n">tree_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tree_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trunk_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tree_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trunk_array</span><span class="p">)</span>
        <span class="n">write_output</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="s2">&quot;output/updated_chm.tif&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CHM.insert_tree">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.insert_tree">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">crown_radius</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">trunk_height</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;parabolic&#39;</span><span class="p">,</span> <span class="n">randomness</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">canopy_base_height</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Insert a parametric tree model into the CHM and trunk height array at the specified location.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            position (tuple): (row, col)    indices for tree center insertion.</span>
<span class="sd">            height (float):                 Total height of the tree.</span>
<span class="sd">            crown_radius (float):           Radius of the crown in real-world units.</span>
<span class="sd">            resolution (float):             Real-world size of each pixel (default = 0.5).</span>
<span class="sd">            trunk_height (float):           Height of the trunk (default = 0.0).</span>
<span class="sd">            type (str):                     Canopy shape type (&#39;gaussian&#39;, &#39;cone&#39;, &#39;parabolic&#39;, &#39;hemisphere&#39;).</span>
<span class="sd">            randomness (float):             Standard deviation for random noise applied to canopy (default = 0.8).</span>
<span class="sd">            canopy_base_height (float):     Height at which the canopy starts above the trunk (default = 0.0).</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Updates CHM and trunk arrays in-place.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="p">)</span>
        <span class="n">new_trunk_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trunk_array</span><span class="p">)</span>

        <span class="n">crown_radius_px</span> <span class="o">=</span> <span class="n">crown_radius</span> <span class="o">/</span> <span class="n">resolution</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">crown_radius_px</span> <span class="o">*</span> <span class="mf">2.5</span><span class="p">)</span>

        <span class="c1"># Calculate the distance from surrounding cells to the tree center</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">canopy_start_height</span> <span class="o">=</span> <span class="n">trunk_height</span> <span class="o">+</span> <span class="n">canopy_base_height</span>

        <span class="c1"># Create canopy shape</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="n">canopy</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">canopy_start_height</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="n">distance</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">crown_radius_px</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">canopy_start_height</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;cone&#39;</span><span class="p">:</span>
            <span class="n">canopy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">height</span> <span class="o">-</span> <span class="n">canopy_start_height</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">distance</span> <span class="o">/</span> <span class="n">crown_radius_px</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="n">height</span> <span class="o">-</span> <span class="n">canopy_start_height</span><span class="p">)</span> <span class="o">+</span> <span class="n">canopy_start_height</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;parabolic&#39;</span><span class="p">:</span>
            <span class="n">canopy</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">canopy_start_height</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">distance</span> <span class="o">/</span> <span class="n">crown_radius_px</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">canopy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">canopy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">canopy_start_height</span><span class="p">)</span> <span class="o">+</span> <span class="n">canopy_start_height</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;hemisphere&#39;</span><span class="p">:</span>
            <span class="n">canopy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">crown_radius_px</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">distance</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="o">/</span> <span class="n">crown_radius_px</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">height</span> <span class="o">-</span> <span class="n">canopy_start_height</span><span class="p">)</span> <span class="o">+</span> <span class="n">canopy_start_height</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported tree type.&quot;</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">crown_radius_px</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">canopy</span> <span class="o">&gt;=</span> <span class="n">canopy_start_height</span><span class="p">)</span>

        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">randomness</span><span class="p">,</span> <span class="n">canopy</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">canopy</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">+=</span> <span class="n">noise</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="n">canopy</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">canopy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">canopy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Define insertion window</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">position</span>
        <span class="n">half_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">r_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span> <span class="o">-</span> <span class="n">half_size</span><span class="p">)</span>
        <span class="n">r_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span> <span class="o">+</span> <span class="n">half_size</span><span class="p">)</span>
        <span class="n">c_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span> <span class="o">-</span> <span class="n">half_size</span><span class="p">)</span>
        <span class="n">c_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">col</span> <span class="o">+</span> <span class="n">half_size</span><span class="p">)</span>

        <span class="c1"># Calculate actual insertion indices</span>
        <span class="n">canopy_r_start</span> <span class="o">=</span> <span class="n">half_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">row</span> <span class="o">-</span> <span class="n">r_start</span><span class="p">)</span>
        <span class="n">canopy_r_end</span> <span class="o">=</span> <span class="n">canopy_r_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">r_end</span> <span class="o">-</span> <span class="n">r_start</span><span class="p">)</span>
        <span class="n">canopy_c_start</span> <span class="o">=</span> <span class="n">half_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">col</span> <span class="o">-</span> <span class="n">c_start</span><span class="p">)</span>
        <span class="n">canopy_c_end</span> <span class="o">=</span> <span class="n">canopy_c_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">c_end</span> <span class="o">-</span> <span class="n">c_start</span><span class="p">)</span>

        <span class="c1"># Blend</span>
        <span class="n">new_array</span><span class="p">[</span><span class="n">r_start</span><span class="p">:</span><span class="n">r_end</span><span class="p">,</span> <span class="n">c_start</span><span class="p">:</span><span class="n">c_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="p">[</span><span class="n">r_start</span><span class="p">:</span><span class="n">r_end</span><span class="p">,</span> <span class="n">c_start</span><span class="p">:</span><span class="n">c_end</span><span class="p">],</span>
            <span class="n">canopy</span><span class="p">[</span><span class="n">canopy_r_start</span><span class="p">:</span><span class="n">canopy_r_end</span><span class="p">,</span> <span class="n">canopy_c_start</span><span class="p">:</span><span class="n">canopy_c_end</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trunk_array</span><span class="p">[</span><span class="n">r_start</span><span class="p">:</span><span class="n">r_end</span><span class="p">,</span> <span class="n">c_start</span><span class="p">:</span><span class="n">c_end</span><span class="p">]</span>

        <span class="n">new_trunk_array</span><span class="p">[</span><span class="n">r_start</span><span class="p">:</span><span class="n">r_end</span><span class="p">,</span> <span class="n">c_start</span><span class="p">:</span><span class="n">c_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">canopy_r_start</span><span class="p">:</span><span class="n">canopy_r_end</span><span class="p">,</span> <span class="n">canopy_c_start</span><span class="p">:</span><span class="n">canopy_c_end</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">trunk_height</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">trunk_height</span><span class="p">,</span>
            <span class="n">existing</span>
        <span class="p">)</span>

        <span class="n">tree_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_array</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="p">)</span>
        <span class="n">shapes_gen</span> <span class="o">=</span> <span class="n">shapes</span><span class="p">(</span><span class="n">tree_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">tree_mask</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">tree_polygons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">geom</span><span class="p">)),</span> <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">shapes_gen</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree_polygons</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree_polygons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trunk_array</span> <span class="o">=</span> <span class="n">new_array</span><span class="p">,</span> <span class="n">new_trunk_array</span></div>


<div class="viewcode-block" id="CHM.insert_random_tree">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.insert_random_tree">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert_random_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span>
                           <span class="n">height_range</span><span class="o">=</span><span class="p">(</span><span class="mf">12.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">),</span>
                           <span class="n">crown_radius_range</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
                           <span class="n">trunk_height_range</span><span class="o">=</span><span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">),</span>
                           <span class="n">canopy_base_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
                           <span class="n">resolution</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">min_canopy_height</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                           <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;parabolic&#39;</span><span class="p">,</span>
                           <span class="n">randomness</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Insert a tree with randomized dimensions and properties at a specified position. Random values are drawn from</span>
<span class="sd">        The specified ranges for height, crown radius, trunk height, and canopy base height. Ensures that the canopy height meets</span>
<span class="sd">        a minimum value.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - position (tuple):             (row, col) position where the tree will be placed.</span>
<span class="sd">        - height_range (tuple):         Range of tree height in meters.</span>
<span class="sd">        - crown_radius_range (tuple):   Range of crown radius in meters.</span>
<span class="sd">        - trunk_height_range (tuple):   Range of trunk height in meters.</span>
<span class="sd">        - canopy_base_range (tuple):    Range of canopy base height in meters.</span>
<span class="sd">        - resolution (float):           Spatial resolution of the map.</span>
<span class="sd">        - min_canopy_height (float):    Minimum allowable canopy height (tree - trunk).</span>
<span class="sd">        - type (str):                   Shape type of the canopy (e.g., &#39;parabolic&#39;).</span>
<span class="sd">        - randomness (float):           Amount of shape noise to apply.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - None</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">tree_height</span> <span class="o">=</span>  <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">height_range</span><span class="p">)</span>
        <span class="n">crown_radius</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">crown_radius_range</span><span class="p">)</span>

        <span class="n">trunk_height</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">trunk_height_range</span><span class="p">)</span>
        <span class="n">trunk_height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">trunk_height</span><span class="p">,</span> <span class="n">tree_height</span> <span class="o">-</span> <span class="n">min_canopy_height</span><span class="p">)</span>

        <span class="n">canopy_base_height</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">canopy_base_range</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_tree</span><span class="p">(</span>
            <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">tree_height</span><span class="p">,</span>
            <span class="n">crown_radius</span><span class="o">=</span><span class="n">crown_radius</span><span class="p">,</span>
            <span class="n">trunk_height</span><span class="o">=</span><span class="n">trunk_height</span><span class="p">,</span>
            <span class="n">canopy_base_height</span><span class="o">=</span><span class="n">canopy_base_height</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
            <span class="n">randomness</span><span class="o">=</span><span class="n">randomness</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CHM.insert_type_tree">
<a class="viewcode-back" href="../../../src.j_dataprep.html#src.j_dataprep.DEMs.CHM.insert_type_tree">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert_type_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;fraxinus&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">canopy_base</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Insert a tree of a specific type and age using pre-defined growth parameters.</span>

<span class="sd">        Parameters are loaded from a JSON database and used to compute the</span>
<span class="sd">        trunk height and crown radius. The canopy type is fixed as parabolic.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - age (int):                   Age of the tree in years.</span>
<span class="sd">        - position (tuple):            (row, col) position where the tree will be placed.</span>
<span class="sd">        - type (str):                  Tree species (default is &#39;fraxinus&#39;).</span>
<span class="sd">        - resolution (float):          Spatial resolution of the map.</span>
<span class="sd">        - canopy_base (float):         Height of the base of the canopy in meters.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - None</span>

<span class="sd">        Raises:</span>
<span class="sd">        - ValueError: If no data exists for the specified tree age.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Find the tree data for the specified age</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;src/j_dataprep/fraxinus_excelsior_database.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">tree_db</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">tree_data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tree_db</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">age</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tree_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data available for age </span><span class="si">{</span><span class="n">age</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Extract the relevant attributes from the tree data</span>
        <span class="n">tree_height</span> <span class="o">=</span> <span class="n">tree_data</span><span class="p">[</span><span class="s2">&quot;tree ht&quot;</span><span class="p">]</span>
        <span class="n">crown_height</span> <span class="o">=</span> <span class="n">tree_data</span><span class="p">[</span><span class="s2">&quot;crown ht&quot;</span><span class="p">]</span>
        <span class="n">crown_dia</span> <span class="o">=</span> <span class="n">tree_data</span><span class="p">[</span><span class="s2">&quot;crown dia&quot;</span><span class="p">]</span>

        <span class="c1"># Calculate derived values</span>
        <span class="n">trunk_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tree_height</span> <span class="o">-</span> <span class="n">crown_height</span><span class="p">)</span>
        <span class="n">crown_radius</span> <span class="o">=</span> <span class="n">crown_dia</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Set defaults for type and randomness</span>
        <span class="n">tree_type</span> <span class="o">=</span> <span class="s1">&#39;parabolic&#39;</span>  <span class="c1"># Canopy type is fixed as parabolic</span>
        <span class="n">randomness</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># Fixed randomness</span>

        <span class="c1"># Insert the tree with the calculated values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_tree</span><span class="p">(</span>
            <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">tree_height</span><span class="p">,</span>
            <span class="n">crown_radius</span><span class="o">=</span><span class="n">crown_radius</span><span class="p">,</span>
            <span class="n">trunk_height</span><span class="o">=</span><span class="n">trunk_height</span><span class="p">,</span>
            <span class="n">canopy_base_height</span><span class="o">=</span><span class="n">canopy_base</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">tree_type</span><span class="p">,</span>
            <span class="n">randomness</span><span class="o">=</span><span class="n">randomness</span>
        <span class="p">)</span></div>
</div>


<span class="c1"># def load_buildings(buildings_path, layer):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Load in the building shapes from a geopackage file.</span>
<span class="c1">#     ----</span>
<span class="c1">#     Input:</span>
<span class="c1">#     - buildings_path (string):   path to the geopackage file.</span>
<span class="c1">#     - layer (string):            (Tile) name of the layer of buildings to be used</span>
<span class="c1">#</span>
<span class="c1">#     Output:</span>
<span class="c1">#     - List of dictionaries: A list of dictionaries containing:</span>
<span class="c1">#       - &quot;geometry&quot;: building geometry in GeoJSON-like format.</span>
<span class="c1">#       - &quot;parcel_id&quot;: corresponding parcel ID.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     buildings_gdf = gpd.read_file(buildings_path, layer=layer)</span>
<span class="c1">#</span>
<span class="c1">#     if &#39;identificatie&#39; not in buildings_gdf.columns:</span>
<span class="c1">#         raise ValueError(&quot;Column &#39;identificatie&#39; not found in the dataset&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     return [{&quot;geometry&quot;: mapping(geom), &quot;parcel_id&quot;: identificatie} for geom, identificatie in zip(buildings_gdf.geometry, buildings_gdf[&quot;identificatie&quot;])]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># bbox = (120570, 487570, 120970, 487870)</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span><span class="mi">121116</span><span class="p">,</span> <span class="mi">492813</span><span class="p">,</span> <span class="mi">121986</span><span class="p">,</span> <span class="mi">493213</span><span class="p">)</span>
    <span class="c1"># &quot;D:/Geomatics/thesis/__newgaptesting/option1&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">output_dir</span><span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;D:/Geomatics/thesis/__newres/otherplace&quot;</span>
    <span class="n">buildings</span> <span class="o">=</span> <span class="n">Buildings</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">building_geometries</span>
    <span class="n">dems</span> <span class="o">=</span> <span class="n">DEMS</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">buildings</span><span class="p">,</span> <span class="n">bridge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
    <span class="n">dtm</span> <span class="o">=</span> <span class="n">dems</span><span class="o">.</span><span class="n">dtm</span>
    <span class="n">dsm</span> <span class="o">=</span> <span class="n">dems</span><span class="o">.</span><span class="n">dsm</span>
    <span class="n">merged_output</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;D:/Geomatics/thesis/__newres/otherplacepointcloud.las&#39;</span>
    <span class="n">chm</span> <span class="o">=</span> <span class="n">CHM</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">dtm</span><span class="p">,</span> <span class="n">dsm</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;temp2&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">merged_output</span><span class="o">=</span><span class="n">merged_output</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">chm</span>

    <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/landcover.tif&quot;</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/final_dtm.tif&quot;</span>
    <span class="c1"># landcover = LandCover(bbox,  resolution = 1, building_data=buildings, dataset_path=dataset)</span>
    <span class="c1"># landcover.save_raster(output, False)</span>

    <span class="c1"># bbox_list = [(120000, 485700, 120126, 485826), (120000, 485700, 120251, 485951), (120000, 485700, 120501, 486201), (120000, 485700, 120751, 486451), (120000, 485700, 121001, 486701), (120000, 485700, 121501, 487201) ]</span>
    <span class="c1"># folder_list = [&#39;250&#39;, &#39;500&#39;, &#39;1000&#39;, &#39;1500&#39;, &#39;2000&#39;, &#39;3000&#39;]</span>
    <span class="c1"># folder = &#39;250&#39;,</span>
    <span class="c1"># bbox = 120000, 485700, 120126, 485826</span>

    <span class="c1"># bbox_list = [(120000, 485700, 121001, 486701), (120000, 485700, 121501, 487201) ]</span>
    <span class="c1"># folder_list = [&#39;2000&#39;, &#39;3000&#39;]</span>
    <span class="c1"># i = 0</span>
    <span class="c1"># for folder in folder_list:</span>
    <span class="c1">#     output_dir=f&quot;D:/Geomatics/optimization_tests/{folder}&quot;</span>
    <span class="c1">#     buildings = Buildings(bbox_list[i], output_folder=output_dir).building_geometries</span>
    <span class="c1">#     dems = DEMS(bbox_list[i], buildings, bridge=True, output_dir=output_dir)</span>
    <span class="c1">#     dtm = dems.dtm</span>
    <span class="c1">#     merged_output= f&#39;pointcloud_{i}.las&#39;</span>
    <span class="c1">#     chm = CHM(bbox_list[i], dtm, 0.25, &quot;output&quot;, &quot;temp2&quot;, output_dir, merged_output=merged_output).chm</span>
    <span class="c1">#     i += 1</span>
    <span class="c1"># bbox_list = [(175905, 317210, 176505, 317810), (84050, 447180, 84650, 447780),(80780, 454550, 81380, 455150),(233400, 581500, 234000, 582100),(136600, 455850, 137200, 456450),(121500, 487000, 122100, 487600)]</span>
    <span class="c1"># for i in [1, 2, 3, 4, 5]:</span>
    <span class="c1">#     output_dir=f&quot;D:/Geomatics/thesis/_analysisfinal/historisch/loc_{i}&quot;</span>
    <span class="c1">#     buildings = Buildings(bbox_list[i]).building_geometries</span>
    <span class="c1">#     dems = DEMS(bbox_list[i], buildings, bridge=True, output_dir=output_dir)</span>
    <span class="c1">#     dtm = dems.dtm</span>
    <span class="c1">#     merged_output= f&#39;his_{i}_pointcloud.las&#39;</span>
    <span class="c1">#     chm = CHM(bbox_list[i], dtm, 0.25, &quot;output&quot;, &quot;temp2&quot;, output_dir, merged_output=merged_output).chm</span>
    <span class="c1">#</span>
    <span class="c1"># bbox_list = [(146100, 486500, 147000, 487400),(153750, 467550, 154650, 468450),(115300, 517400, 116100, 518250),(102000, 475900, 103100, 476800),(160750, 388450, 161650, 389350),(84350, 449800, 85250, 450700)]</span>
    <span class="c1"># for i in [0, 1, 2, 3, 4, 5]:</span>
    <span class="c1">#     output_dir = f&quot;D:/Geomatics/thesis/_analysisfinal/vinex/loc_{i}&quot;</span>
    <span class="c1">#     buildings = Buildings(bbox_list[i]).building_geometries</span>
    <span class="c1">#     dems = DEMS(bbox_list[i], buildings, bridge=True, output_dir=output_dir)</span>
    <span class="c1">#     dtm = dems.dtm</span>
    <span class="c1">#     merged_output = f&#39;vinex_{i}_pointcloud.las&#39;</span>
    <span class="c1">#     chm = CHM(bbox_list[i], dtm, 0.25, &quot;output&quot;, &quot;temp2&quot;, output_dir, merged_output=merged_output).chm</span>
    <span class="c1">#</span>
    <span class="c1"># bbox_list = [(90300, 436900, 91300, 437600),(91200, 438500, 92100, 439300),(121350, 483750, 122250, 484650),(118400, 486400, 119340, 487100)]</span>
    <span class="c1"># for i in [0, 1, 2, 3]:</span>
    <span class="c1">#     output_dir = f&quot;D:/Geomatics/thesis/_analysisfinal/stedelijk/loc_{i}&quot;</span>
    <span class="c1">#     buildings = Buildings(bbox_list[i]).building_geometries</span>
    <span class="c1">#     dems = DEMS(bbox_list[i], buildings, bridge=True, output_dir=output_dir)</span>
    <span class="c1">#     dtm = dems.dtm</span>
    <span class="c1">#     merged_output = f&#39;sted_{i}_pointcloud.las&#39;</span>
    <span class="c1">#     chm = CHM(bbox_list[i], dtm, 0.25, &quot;output&quot;, &quot;temp2&quot;, output_dir, merged_output=merged_output).chm</span>
    <span class="c1">#</span>
   <span class="c1"># bbox_list = [(81700, 427490, 82700, 428200),(84050, 444000, 84950, 444900),(116650, 518700, 117550, 519600),(235050, 584950, 235950, 585850),(210500, 473900, 211400, 474800),(154700, 381450, 155700, 382150)]</span>
    <span class="c1"># for i in [0, 1, 2, 3, 4, 5]:</span>
    <span class="c1">#     output_dir = f&quot;D:/Geomatics/thesis/_analysisfinal/bloemkool/loc_{i}&quot;</span>
    <span class="c1">#     buildings = Buildings(bbox_list[i]).building_geometries</span>
    <span class="c1">#     dems = DEMS(bbox_list[i], buildings, bridge=True, output_dir=output_dir)</span>
    <span class="c1">#     dtm = dems.dtm</span>
    <span class="c1">#     merged_output = f&#39;bloem_{i}_pointcloud.las&#39;</span>
    <span class="c1">#     chm = CHM(bbox_list[i], dtm, 0.25, &quot;output&quot;, &quot;temp2&quot;, output_dir, merged_output=merged_output).chm</span>
    <span class="c1">#</span>
     <span class="c1">#bbox_list = [(76800, 455000, 78200, 455700),(152600, 463250, 153900, 463800),(139140, 469570, 139860, 470400),(190850, 441790, 191750, 442540),(113100, 551600, 113650, 552000),(32050, 391900, 32850, 392500)]</span>
    <span class="c1"># for i in [0, 1, 2, 3, 4, 5]:</span>
    <span class="c1">#     output_dir = f&quot;D:/Geomatics/thesis/_analysisfinal/tuindorp/loc_{i}&quot;</span>
    <span class="c1">#     buildings = Buildings(bbox_list[i]).building_geometries</span>
    <span class="c1">#     dems = DEMS(bbox_list[i], buildings, bridge=True, output_dir=output_dir)</span>
    <span class="c1">#     dtm = dems.dtm</span>
    <span class="c1">#     merged_output = f&#39;tuin_{i}_pointcloud.las&#39;</span>
    <span class="c1">#     chm = CHM(bbox_list[i], dtm, 0.25, &quot;output&quot;, &quot;temp2&quot;, output_dir, merged_output=merged_output).chm</span>

    <span class="c1"># bbox_dict = {</span>
    <span class="c1">#     &#39;historisch&#39;: [(175905, 317210, 176505, 317810), (84050, 447180, 84650, 447780),(80780, 454550, 81380, 455150),(233400, 581500, 234000, 582100),(136600, 455850, 137200, 456450),(121500, 487000, 122100, 487600)</span>
    <span class="c1">#     ],</span>
    <span class="c1">#     &#39;tuindorp&#39;: [(76800, 455000, 78200, 455700),(152600, 463250, 153900, 463800),(139140, 469570, 139860, 470400),(190850, 441790, 191750, 442540),(113100, 551600, 113650, 552000),(32050, 391900, 32850, 392500)</span>
    <span class="c1">#</span>
    <span class="c1">#     ],</span>
    <span class="c1">#     &#39;vinex&#39;: [(146100, 486500, 147000, 487400),(153750, 467550, 154650, 468450),(115300, 517400, 116100, 518250),(102000, 475900, 103100, 476800),(160750, 388450, 161650, 389350),(84350, 449800, 85250, 450700)</span>
    <span class="c1">#</span>
    <span class="c1">#     ],</span>
    <span class="c1">#     &#39;volkswijk&#39;: [(104200, 490550, 105100, 491450), (78200, 453900, 79100, 454800), (83500, 447020, 84050, 447900),</span>
    <span class="c1">#              (136200, 456500, 137100, 457300), (182700, 579200, 183800, 579750),</span>
    <span class="c1">#              (233400, 582800, 234300, 583700)</span>
    <span class="c1">#</span>
    <span class="c1">#     ],</span>
    <span class="c1">#     &#39;bloemkool&#39;: [(81700, 427490, 82700, 428200),(84050, 444000, 84950, 444900),(116650, 518700, 117550, 519600),(235050, 584950, 235950, 585850),(210500, 473900, 211400, 474800),(154700, 381450, 155700, 382150)</span>
    <span class="c1">#</span>
    <span class="c1">#     ],</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;stedelijk&#39;:[</span>
    <span class="c1">#         (90300, 436900, 91300, 437600), (91200, 438500, 92100, 439300), (121350, 483750, 122250, 484650),</span>
    <span class="c1">#         (118400, 486400, 119340, 487100)</span>
    <span class="c1">#     ]</span>
    <span class="c1"># }</span>

    <span class="c1"># for nbh_type in [&#39;historisch&#39;, &#39;tuindorp&#39;, &#39;vinex&#39;, &#39;volkswijk&#39;, &#39;bloemkool&#39;]:</span>
    <span class="c1">#     for i in [0, 1, 2, 3, 4, 5]:</span>
    <span class="c1">#         output_dir = f&quot;E:/Geomatics/thesis/_analysisfinal/{nbh_type}/loc_{i}&quot;</span>
    <span class="c1">#         buildings = Buildings(bbox_dict[nbh_type][i],</span>
    <span class="c1">#                               gpkg_name=f&quot;E:/Geomatics/thesis/_analysisfinal/{nbh_type}/loc_{i}/buildings&quot;).building_geometries</span>

    <span class="c1"># for nbh_type in [&#39;stedelijk&#39;]:</span>
    <span class="c1">#     for i in [0, 1, 2, 3]:</span>
    <span class="c1">#         output_dir = f&quot;E:/Geomatics/thesis/_analysisfinal/{nbh_type}/loc_{i}&quot;</span>
    <span class="c1">#         buildings = Buildings(bbox_dict[nbh_type][i],</span>
    <span class="c1">#                               gpkg_name=f&quot;E:/Geomatics/thesis/_analysisfinal/{nbh_type}/loc_{i}/buildings&quot;).building_geometries</span>


    <span class="c1"># for i in [0, 1, 2, 3, 4, 5]:</span>
    <span class="c1">#     output_dir = f&quot;E:/Geomatics/thesis/_analysisfinal/volkswijk/loc_{i}&quot;</span>

        <span class="c1"># dems = DEMS(bbox_list[i], buildings, bridge=True, output_dir=output_dir)</span>
        <span class="c1"># dtm = dems.dtm</span>
        <span class="c1"># merged_output = f&#39;volk_{i}_pointcloud.las&#39;</span>
        <span class="c1"># chm = CHM(bbox_list[i], dtm, 0.25, &quot;output&quot;, &quot;temp2&quot;, output_dir, merged_output=merged_output).chm</span>
    <span class="c1">#</span>
    <span class="c1"># for i in [0, 1, 2, 3, 4, 5]:</span>
    <span class="c1">#     output_dir = f&quot;D:/Geomatics/thesis/_analysisfinal/volkswijk/loc_{i}&quot;</span>
    <span class="c1">#     buildings = Buildings(bbox_list[i]).building_geometries</span>
    <span class="c1">#     dems = DEMS(bbox_list[i], buildings, bridge=True, output_dir=output_dir)</span>
    <span class="c1">#     dtm = dems.dtm</span>
    <span class="c1">#     merged_output = f&#39;volk_{i}_pointcloud.las&#39;</span>
    <span class="c1">#     chm = CHM(bbox_list[i], dtm, 0.25, &quot;output&quot;, &quot;temp2&quot;, output_dir, merged_output=merged_output).chm</span>


    <span class="c1"># buildings = Buildings(bbox).data</span>
    <span class="c1"># # buildings_data = load_buildings(&quot;temp/buildings_test.gpkg&quot;, &quot;buildings&quot;)</span>
    <span class="c1">#</span>
    <span class="c1"># # DEMS = DEMS(bbox, buildings_data)</span>
    <span class="c1"># # dtm = DEMS.dtm</span>
    <span class="c1"># # dsm = DEMS.dsm</span>
    <span class="c1"># with rasterio.open(&quot;output/final_dtm_test.tif&quot;) as src:</span>
    <span class="c1">#     dtm = src.read(1)</span>
    <span class="c1"># chm = CHM(bbox, dtm, &quot;output&quot;, &quot;temp2&quot;).chm</span>


    <span class="c1"># def plot_raster(filepath, title=&quot;Raster Data&quot;):</span>
    <span class="c1">#     with rasterio.open(filepath) as src:</span>
    <span class="c1">#         array = src.read(1)</span>
    <span class="c1">#         plt.figure(figsize=(10, 8))</span>
    <span class="c1">#         plt.imshow(array, cmap=&quot;viridis&quot;, origin=&quot;upper&quot;)</span>
    <span class="c1">#         plt.colorbar(label=&quot;Elevation (m)&quot;)</span>
    <span class="c1">#         plt.title(title)</span>
    <span class="c1">#         plt.show()</span>

    <span class="c1"># plot_raster(&quot;output/final_dtm_test.tif&quot;, &quot;Final Filled DTM&quot;)</span>
    <span class="c1"># plot_raster(&quot;output/final_dsm_test.tif&quot;, &quot;Final filled DSM&quot;)</span>
    <span class="c1"># plot_raster(&quot;output/CHM_test.tif&quot;, &quot;Final CHM&quot;)</span>
    <span class="c1">#</span>
    <span class="c1"># with rasterio.open(&quot;output/CHM_test.tif&quot;) as src:</span>
    <span class="c1">#     tree_height = src.read(1)</span>
    <span class="c1">#     transform = src.transform</span>
    <span class="c1">#     crs = src.crs</span>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Jessica Monahan
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>